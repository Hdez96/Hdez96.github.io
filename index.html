<title>Dimmer</title>
  </head>
  <body>
    <p class="bubble">
      Hello again! Time to light up an LED. ðŸ’¡
    </p>

    <noscript>
      <p class="notice bubble">
        I'm sorry! For this to actully work you have to enable JavaScript in your browser.
      </p>
    </noscript>

    <button id="connect-button" type="button" disabled>ðŸ”Œ Connect</button>

    <figure class="fast animated">
      <input id="led-dimmer" type="range" min="0" max="255" value="0" class="demo bubble" disabled />
      <figcaption><label for="led-dimmer">LED dimmer<br /><small><span>0</span> % brightness</small></label></figcaption>
    </figure>

    <script>
      const connectButton = document.getElementById ('connect-button');
let port;

if ('serial' in navigator) {
  connectButton.addEventListener('click', function () {
    if (port) {
      port.close();
      port = undefined;

      connectButton.innerText = 'ðŸ”Œ Connect';
      document.querySelector('figure').classList.replace('bounceIn', 'fadeOut');
    }
    else {
      getReader();
    }
  });

  connectButton.disabled = false;
}
else {
  const firstBubble = document.querySelector('p.bubble');
  const noSerialSupportNotice = document.createElement('p');
  noSerialSupportNotice.innerHTML = '<p class="notice bubble">You\'re on the right track! This browser is lacking support for Web Serial API, though, and thats a bummer.</p>';

  firstBubble.parentNode.insertBefore(noSerialSupportNotice, firstBubble.nextSibling);
}
      const ledDimmer = document.getElementById('led-dimmer');
      const ledDimmerValue = document.querySelector('label span');

      function renderDemo() {
        const percent = Math.floor(ledDimmer.value / 255 * 100);

        ledDimmer.style = 'background-image: linear-gradient(to right, #fed609 ' + percent + '%, #2c2b2f ' + percent + '%);';
        ledDimmerValue.innerText = percent;

        window.requestAnimationFrame(renderDemo);
      }
      window.requestAnimationFrame(renderDemo);

      async function getReader() {
        port = await navigator.serial.requestPort({});
        await port.open({ baudrate: 9600 });

        document.querySelector('input').disabled = false;
        connectButton.innerText = 'ðŸ”Œ Disconnect';
        document.querySelector('figure').classList.remove('fadeOut');
        document.querySelector('figure').classList.add('bounceIn');

        ledDimmer.addEventListener('input', (event) => {
          if (port && port.writable) {
            const value = parseInt(event.target.value);
            const bytes = new Uint8Array([value]);
            const writer = port.writable.getWriter();

            writer.write(bytes);
            writer.releaseLock();
          }
        });
      }
    </script>
